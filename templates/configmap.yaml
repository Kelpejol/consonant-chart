{{/*
ConfigMap - Non-Sensitive Configuration
========================================
Stores application configuration files
Changes trigger pod restart via checksum annotation
*/}}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "consonant-relayer.fullname" . }}-config
  namespace: {{ include "consonant-relayer.namespace" . }}
  labels:
    {{- include "consonant-relayer.labels" . | nindent 4 }}
    app.kubernetes.io/component: configuration
  {{- with (include "consonant-relayer.annotations" .) }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
data:
  # Cluster configuration
  cluster.yaml: |
    name: {{ .Values.cluster.name | quote }}
    namespace: {{ include "consonant-relayer.namespace" . | quote }}
    {{- if .Values.cluster.region }}
    region: {{ .Values.cluster.region | quote }}
    {{- end }}
    {{- if .Values.cluster.environment }}
    environment: {{ .Values.cluster.environment | quote }}
    {{- end }}
    {{- with .Values.cluster.metadata }}
    metadata:
      {{- toYaml . | nindent 6 }}
    {{- end }}
  
  # Backend configuration
  backend.yaml: |
   url: {{ .Values.backend.url | quote }}
    grpcEndpoint: {{ include "consonant-relayer.grpcEndpoint" . | quote }}
    tlsVerify: {{ .Values.backend.tlsVerify }}
    connectionTimeout: {{ .Values.backend.connectionTimeout }}

    grpc:
      keepalive:
        time: {{ .Values.backend.grpc.keepalive.time }}
        timeout: {{ .Values.backend.grpc.keepalive.timeout }}
        permitWithoutStream: {{ .Values.backend.grpc.keepalive.permitWithoutStream }}
    
    circuitBreaker:
      enabled: {{ .Values.backend.circuitBreaker.enabled }}
      failureThreshold: {{ .Values.backend.circuitBreaker.failureThreshold }}
      successThreshold: {{ .Values.backend.circuitBreaker.successThreshold }}
      timeout: {{ .Values.backend.circuitBreaker.timeout }}
      halfOpenMaxAttempts: {{ .Values.backend.circuitBreaker.halfOpenMaxAttempts }}
    
    reconnection:
      enabled: {{ .Values.backend.reconnection.enabled }}
      delay: {{ .Values.backend.reconnection.delay }}
      maxDelay: {{ .Values.backend.reconnection.maxDelay }}
      multiplier: {{ .Values.backend.reconnection.multiplier }}
      maxAttempts: {{ .Values.backend.reconnection.maxAttempts }}
      jitter: {{ .Values.backend.reconnection.jitter }}
    
    healthCheck:
      enabled: {{ .Values.backend.healthCheck.enabled }}
      interval: {{ .Values.backend.healthCheck.interval }}
      timeout: {{ .Values.backend.healthCheck.timeout }}
      unhealthyThreshold: {{ .Values.backend.healthCheck.unhealthyThreshold }}
    
  # LLM configuration
  llm.yaml: |
    provider: {{ .Values.llm.provider | quote }}
    model: {{ .Values.llm.model | quote }}
    
    {{- if .Values.llm.fallbackModels }}
    fallbackModels:
      {{- toYaml .Values.llm.fallbackModels | nindent 6 }}
    {{- end }}
    
    validation:
      enabled: {{ .Values.llm.validation.enabled }}
    
    rateLimit:
      enabled: {{ .Values.llm.rateLimit.enabled }}
      requestsPerMinute: {{ .Values.llm.rateLimit.requestsPerMinute }}
      burst: {{ .Values.llm.rateLimit.burst }}
    
    retry:
      maxAttempts: {{ .Values.llm.retry.maxAttempts }}
      initialDelay: {{ .Values.llm.retry.initialDelay }}
      maxDelay: {{ .Values.llm.retry.maxDelay }}
      multiplier: {{ .Values.llm.retry.multiplier }}
    
    timeout:
      request: {{ .Values.llm.timeout.request }}
      stream: {{ .Values.llm.timeout.stream }}
    
    {{- if eq .Values.llm.provider "openai" }}
    openai:
      baseURL: {{ .Values.llm.openai.baseURL | quote }}
      {{- if .Values.llm.openai.organization }}
      organization: {{ .Values.llm.openai.organization | quote }}
      {{- end }}
    {{- else if eq .Values.llm.provider "anthropic" }}
    anthropic:
      baseURL: {{ .Values.llm.anthropic.baseURL | quote }}
      apiVersion: {{ .Values.llm.anthropic.apiVersion | quote }}
    {{- else if eq .Values.llm.provider "gemini" }}
    gemini:
      baseURL: {{ .Values.llm.gemini.baseURL | quote }}
    {{- else if eq .Values.llm.provider "ollama" }}
    ollama:
      baseURL: {{ .Values.llm.ollama.baseURL | quote }}
      keepAlive: {{ .Values.llm.ollama.keepAlive | quote }}
    {{- end }}
  
  # Logging configuration
  logging.yaml: |
    level: {{ .Values.relayer.logging.level | quote }}
    format: {{ .Values.relayer.logging.format | quote }}
    structured: {{ .Values.relayer.logging.structured }}
    
    {{- if .Values.relayer.logging.sampling.enabled }}
    sampling:
      enabled: true
      initial: {{ .Values.relayer.logging.sampling.initial }}
      thereafter: {{ .Values.relayer.logging.sampling.thereafter }}
    {{- end }}
  
 
  # Release metadata
  release.yaml: |
    name: {{ .Release.Name | quote }}
    namespace: {{ .Release.Namespace | quote }}
    chart:
      name: {{ .Chart.Name | quote }}
      version: {{ .Chart.Version | quote }}
    app:
      version: {{ .Chart.AppVersion | quote }}
    kubernetes:
      version: {{ .Capabilities.KubeVersion.Version | quote }}
    helm:
      version: {{ .Capabilities.HelmVersion.Version | quote }}