{{/*
Deployment - Production-Grade Relayer Application
==================================================
Complete rewrite with all security fixes and best practices
*/}}

{{/* Run all validations first */}}
{{- include "consonant-relayer.validate.all" . }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "consonant-relayer.fullname" . }}
  namespace: {{ include "consonant-relayer.namespace" . }}
  labels:
    {{- include "consonant-relayer.labels" . | nindent 4 }}
    app.kubernetes.io/component: relayer
  {{- with (include "consonant-relayer.annotations" .) }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ .Values.relayer.replicas }}
  
  {{/* Deployment strategy */}}
  strategy:
    {{- toYaml .Values.relayer.strategy | nindent 4 }}
  
  {{/* Pod selector - IMMUTABLE */}}
  selector:
    matchLabels:
      {{- include "consonant-relayer.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: relayer
  
  {{/* Pod template */}}
  template:
    metadata:
      labels:
        {{- include "consonant-relayer.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: relayer
        {{- with .Values.relayer.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      annotations:
        {{/* Force restart on config/secret changes */}}
        {{- include "consonant-relayer.configChecksum" . | nindent 8 }}
        {{- if not (include "consonant-relayer.useExternalSecrets" .) }}
        {{- include "consonant-relayer.secretsChecksum" . | nindent 8 }}
        {{- end }}
        {{- with .Values.relayer.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    
    spec:
      {{/* Service account */}}
      serviceAccountName: {{ include "consonant-relayer.serviceAccountName" . }}
      automountServiceAccountToken: {{ .Values.serviceAccount.automount }}
      
      {{/* Image pull secrets */}}
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{/* Pod security context */}}
      securityContext:
        {{- toYaml .Values.relayer.podSecurityContext | nindent 8 }}
      
      {{/* Priority class */}}
      {{- with .Values.relayer.priorityClassName }}
      priorityClassName: {{ . }}
      {{- end }}
      
      {{/* DNS configuration */}}
      dnsPolicy: {{ .Values.relayer.dnsPolicy }}
      {{- with .Values.relayer.dnsConfig }}
      dnsConfig:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{/* Termination grace period */}}
      terminationGracePeriodSeconds: {{ .Values.relayer.terminationGracePeriodSeconds }}
      
      {{/*
      =============================================
      INIT CONTAINERS (FIXED)
      =============================================
      */}}
      initContainers:
      {{/* Wait for cluster credentials secret */}}
      - name: wait-for-credentials
        image: {{ include "consonant-relayer.kubectlImage" . }}
        imagePullPolicy: {{ .Values.hooks.registration.kubectlImage.pullPolicy }}
        command:
          - sh
          - -c
          - |
            set -e
            echo "‚è≥ Waiting for cluster credentials secret..."
            echo "   Secret: {{ include "consonant-relayer.clusterSecretName" . }}"
            echo "   Namespace: {{ include "consonant-relayer.namespace" . }}"
            
            # ‚úÖ FIXED: Added timeout
            timeout=300  # 5 minutes
            elapsed=0
            interval=2
            
            while [ $elapsed -lt $timeout ]; do
              if kubectl get secret {{ include "consonant-relayer.clusterSecretName" . }} \
                  -n {{ include "consonant-relayer.namespace" . }} &>/dev/null; then
                echo "‚úÖ Credentials secret found!"
                
                # Verify secret has required keys
                if kubectl get secret {{ include "consonant-relayer.clusterSecretName" . }} \
                    -n {{ include "consonant-relayer.namespace" . }} \
                    -o jsonpath='{.data.clusterId}' | base64 -d &>/dev/null && \
                   kubectl get secret {{ include "consonant-relayer.clusterSecretName" . }} \
                    -n {{ include "consonant-relayer.namespace" . }} \
                    -o jsonpath='{.data.clusterToken}' | base64 -d &>/dev/null; then
                  echo "‚úÖ Secret contains required keys: clusterId, clusterToken"
                  exit 0
                else
                  echo "‚ùå ERROR: Secret is missing required keys"
                  exit 1
                fi
              fi
              
              echo "   Waiting... (${elapsed}s / ${timeout}s)"
              sleep $interval
              elapsed=$((elapsed + interval))
            done
            
            echo "‚ùå ERROR: Timeout waiting for credentials secret"
            echo ""
            echo "Troubleshooting:"
            echo "  1. Check pre-install hook job:"
            echo "     kubectl logs -n {{ include "consonant-relayer.namespace" . }} job/{{ include "consonant-relayer.fullname" . }}-register"
            echo ""
            echo "  2. Check if secret exists:"
            echo "     kubectl get secret -n {{ include "consonant-relayer.namespace" . }}"
            echo ""
            echo "  3. Verify RBAC permissions:"
            echo "     kubectl auth can-i get secrets -n {{ include "consonant-relayer.namespace" . }} --as=system:serviceaccount:{{ include "consonant-relayer.namespace" . }}:{{ include "consonant-relayer.serviceAccountName" . }}"
            exit 1
        
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
          seccompProfile:
            type: RuntimeDefault
        
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
        
        volumeMounts:
          - name: tmp
            mountPath: /tmp
      
    
      {{/*
      =============================================
      MAIN CONTAINERS
      =============================================
      */}}
      containers:
      {{/* RELAYER CONTAINER */}}
      - name: relayer
        image: {{ include "consonant-relayer.relayerImage" . }}
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        
        {{/* Container security context */}}
        securityContext:
          {{- toYaml .Values.relayer.securityContext | nindent 10 }}
        
        {{/* Environment variables */}}
        env:
        {{/* Core configuration */}}
        - name: NODE_ENV
          value: "production"
        
        - name: LOG_LEVEL
          value: {{ .Values.relayer.logging.level | quote }}
        
        - name: LOG_FORMAT
          value: {{ .Values.relayer.logging.format | quote }}

          - name: LOG_STRUCTURED
          value: {{ .Values.mediator.logging.structured | quote }}
        
        {{/* Cluster identity */}}
        - name: CLUSTER_ID
          valueFrom:
            secretKeyRef:
              name: {{ include "consonant-relayer.clusterSecretName" . }}
              key: {{ .Values.backend.credentials.existingSecretKeys.clusterId }}
        
        - name: CLUSTER_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ include "consonant-relayer.clusterSecretName" . }}
              key: {{ .Values.backend.credentials.existingSecretKeys.clusterToken }}
        
        - name: CLUSTER_NAME
          value: {{ .Values.cluster.name | quote }}
        
        - name: CLUSTER_NAMESPACE
          value: {{ include "consonant-relayer.namespace" . | quote }}
        
        {{- if .Values.cluster.region }}
        - name: CLUSTER_REGION
          value: {{ .Values.cluster.region | quote }}
        {{- end }}
        
        {{- if .Values.cluster.environment }}
        - name: CLUSTER_ENVIRONMENT
          value: {{ .Values.cluster.environment | quote }}
        {{- end }}
        
        {{/* Cluster metadata as JSON */}}
        - name: CLUSTER_METADATA
          value: {{ include "consonant-relayer.clusterMetadata" . | quote }}
        
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        
       # gRPC configuration
        - name: GRPC_KEEPALIVE_TIME
          value: {{ .Values.backend.grpc.keepalive.time | quote }}
        
        - name: GRPC_KEEPALIVE_TIMEOUT
          value: {{ .Values.backend.grpc.keepalive.timeout | quote }}
        
        - name: GRPC_KEEPALIVE_PERMIT_WITHOUT_STREAM
          value: {{ .Values.backend.grpc.keepalive.permitWithoutStream | quote }}

        {{/* Circuit breaker */}}
        - name: CIRCUIT_BREAKER_ENABLED
          value: {{ .Values.backend.circuitBreaker.enabled | quote }}
        
        - name: CIRCUIT_BREAKER_FAILURE_THRESHOLD
          value: {{ .Values.backend.circuitBreaker.failureThreshold | quote }}
        
        - name: CIRCUIT_BREAKER_SUCCESS_THRESHOLD
          value: {{ .Values.backend.circuitBreaker.successThreshold | quote }}
        
        - name: CIRCUIT_BREAKER_TIMEOUT
          value: {{ .Values.backend.circuitBreaker.timeout | quote }}
        
       
       # Reconnection strategy
        - name: RECONNECTION_ENABLED
          value: {{ .Values.backend.reconnection.enabled | quote }}
        
        {{- if .Values.backend.reconnection.enabled }}
        - name: RECONNECTION_INITIAL_DELAY
          value: {{ .Values.backend.reconnection.initialDelay | quote }}
        
        - name: RECONNECTION_MAX_DELAY
          value: {{ .Values.backend.reconnection.maxDelay | quote }}
        
        - name: RECONNECTION_MULTIPLIER
          value: {{ .Values.backend.reconnection.multiplier | quote }}
        
         - name: RECONNECTION_JITTER
          value: {{ .Values.backend.reconnection.jitter | quote }}
        {{- end }}

            
        {{/* Health endpoint */}}
        - name: HEALTH_PORT
          value: {{ .Values.relayer.health.port | quote }}
        
        {{/* Container ports */}}
        
        - name: health
          containerPort: {{ .Values.relayer.health.port }}
          protocol: TCP
        
        {{/* Liveness probe */}}
        livenessProbe:
          httpGet:
            path: /liveness
            port: health
            scheme: HTTP
          initialDelaySeconds: {{ .Values.relayer.health.liveness.initialDelaySeconds }}
          periodSeconds: {{ .Values.relayer.health.liveness.periodSeconds }}
          timeoutSeconds: {{ .Values.relayer.health.liveness.timeoutSeconds }}
          failureThreshold: {{ .Values.relayer.health.liveness.failureThreshold }}
          successThreshold: {{ .Values.relayer.health.liveness.successThreshold }}
        
        {{/* Readiness probe */}}
        readinessProbe:
          httpGet:
            path: /readiness
            port: health
            scheme: HTTP
          initialDelaySeconds: {{ .Values.relayer.health.readiness.initialDelaySeconds }}
          periodSeconds: {{ .Values.relayer.health.readiness.periodSeconds }}
          timeoutSeconds: {{ .Values.relayer.health.readiness.timeoutSeconds }}
          failureThreshold: {{ .Values.relayer.health.readiness.failureThreshold }}
          successThreshold: {{ .Values.relayer.health.readiness.successThreshold }}
        
        {{/* Startup probe */}}
        startupProbe:
          httpGet:
            path: /health
            port: health
            scheme: HTTP
          initialDelaySeconds: {{ .Values.relayer.health.startup.initialDelaySeconds }}
          periodSeconds: {{ .Values.relayer.health.startup.periodSeconds }}
          timeoutSeconds: {{ .Values.relayer.health.startup.timeoutSeconds }}
          failureThreshold: {{ .Values.relayer.health.startup.failureThreshold }}
          successThreshold: {{ .Values.relayer.health.startup.successThreshold }}
        
        {{/* Lifecycle hooks (FIXED) */}}
        lifecycle:
          postStart:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  echo "üöÄ Container started, verifying gRPC connection..."
                  
                  timeout={{ .Values.relayer.lifecycle.postStart.timeout }}
                  elapsed=0
                  interval=2
                  
                  while [ $elapsed -lt $timeout ]; do
                    if wget -q -O- --timeout=3 http://localhost:${HEALTH_PORT}/readiness 2>/dev/null | grep -q '"connected":true'; then
                      echo "‚úÖ gRPC  connected successfully!"
                      exit 0
                    fi
                    
                    echo "‚è≥ Waiting for gRPC  connection... (${elapsed}s / ${timeout}s)"
                    sleep $interval
                    elapsed=$((elapsed + interval))
                  done
                  
                  echo "‚ùå ERROR: gRPC  connection not established within ${timeout}s"
                  {{- if .Values.relayer.lifecycle.postStart.failOnError }}
                  exit 1  # ‚úÖ FIXED: Fail pod if connection fails
                  {{- else }}
                  exit 0  # Allow pod to start anyway
                  {{- end }}
          
          preStop:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  echo "üõë Graceful shutdown initiated..."
                  {{- if .Values.relayer.lifecycle.preStop.waitForRequests }}
                  echo "‚è≥ Waiting {{ .Values.relayer.lifecycle.preStop.delay }}s for in-flight requests..."
                  sleep {{ .Values.relayer.lifecycle.preStop.delay }}
                  {{- end }}
                  echo "‚úÖ Shutdown complete"
        
        {{/* Resources */}}
        resources:
          {{- toYaml .Values.relayer.resources | nindent 10 }}
        
        {{/* Volume mounts */}}
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /.npm
        - name: config
          mountPath: /etc/consonant
          readOnly: true
      
      
      {{/*
      =============================================
      VOLUMES
      =============================================
      */}}
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi
      
      - name: cache
        emptyDir:
          sizeLimit: 500Mi
      
      - name: config
        configMap:
          name: {{ include "consonant-relayer.fullname" . }}-config
          defaultMode: 0444
      
      {{/*
      =============================================
      POD SCHEDULING
      =============================================
      */}}
      {{- with .Values.relayer.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{- with .Values.relayer.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{- with .Values.relayer.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      {{- with .Values.relayer.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml . | nindent 8 }}
      {{- end }}