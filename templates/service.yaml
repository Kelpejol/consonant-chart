{{/*
Service - Internal Networking
==============================
Creates a ClusterIP service for the relayer
Exposes two ports:
1. OTEL port (4317) - KAgent sends traces here
2. Health port (8080) - K8s health checks

SERVICE TYPE: ClusterIP
- Internal only, not exposed outside cluster
- KAgent can reach via DNS: <service-name>.<namespace>.svc.cluster.local:4317
- Example: my-release-consonant-relayer.consonant-system.svc.cluster.local:4317

WHY NOT LoadBalancer/NodePort?
- OTEL endpoint is internal infrastructure
- Only KAgent (in same namespace) needs to reach it
- Backend reaches relayer via Cloudflare tunnel (WebSocket)
- No need for external access

DNS RESOLUTION:
- Short form (same namespace): my-release-consonant-relayer:4317
- Full form: my-release-consonant-relayer.consonant-system.svc.cluster.local:4317
- KAgent uses the short form in its OTEL config
*/}}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "consonant-relayer.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "consonant-relayer.labels" . | nindent 4 }}
    app.kubernetes.io/component: relayer
  {{- with .Values.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  # Service type
  # ClusterIP = internal only
  # LoadBalancer = creates cloud load balancer (not needed)
  # NodePort = exposes on node IP (not needed)
  type: {{ .Values.service.type }}
  
  # Selector matches pods with these labels
  # Traffic is distributed across all matching pods
  selector:
    {{- include "consonant-relayer.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: relayer
  
  # Ports exposed by this service
  ports:
  # ===== OTEL Port =====
  # KAgent sends traces and logs here
  # Protocol: gRPC over HTTP/2
  - name: otel
    port: {{ .Values.service.otelPort }}         # Service port (what clients connect to)
    targetPort: otel                             # Pod port name (from deployment)
    protocol: TCP
    {{- if and (eq .Values.service.type "NodePort") .Values.service.otelNodePort }}
    nodePort: {{ .Values.service.otelNodePort }}
    {{- end }}
  
  # ===== Health Port =====
  # K8s probes use this for health checks
  # Also can be used for metrics/debugging
  - name: health
    port: {{ .Values.service.healthPort }}
    targetPort: health
    protocol: TCP
    {{- if and (eq .Values.service.type "NodePort") .Values.service.healthNodePort }}
    nodePort: {{ .Values.service.healthNodePort }}
    {{- end }}
  
  # Session affinity
  # None = random distribution (default)
  # ClientIP = sticky sessions based on client IP
  sessionAffinity: None
  
  # IP families (IPv4/IPv6)
  # SingleStack = IPv4 only (default)
  # DualStack = both IPv4 and IPv6
  ipFamilyPolicy: SingleStack
  ipFamilies:
    - IPv4